# DeFi Staking Contract - Yield Farming 101 A comprehensive DeFi staking smart contract demonstrating advanced blockchain concepts including yield farming, time-locked staking, reward multipliers, and security best practices. ## What You'll Learn - DeFi Mechanisms: Staking, yield farming, liquidity provision - Time-Locked Staking: Different lock periods with reward multipliers - Reward Calculations: Per-second reward distribution algorithms - Security Patterns: Reentrancy guards, pause mechanisms, emergency withdrawals - Gas Optimization: Efficient reward calculation and state management - Mathematical Safety: SafeMath and overflow protection - Access Control: Owner permissions and user authorization ## Key Features ### Flexible Staking Options - Multiple Lock Periods: 1 week, 1 month, 3 months, 1 year - Reward Multipliers: Up to 2x rewards for longer locks - Compound Rewards: Claim rewards without unstaking - Emergency Withdrawal: Exit early (forfeit rewards) ### Security First - Reentrancy Protection: Prevents double-spending attacks - Pausable Contract: Emergency stop mechanism - Overflow Protection: SafeMath for all calculations - Access Controls: Owner-only administrative functions ### Gas Efficient - Optimized Calculations: Minimal storage operations - Batch Processing: Efficient reward distribution - View Functions: Off-chain calculations when possible - Event Logging: Comprehensive activity tracking ## Contract Architecture ### Core Data Structures #### StakeInfo ```solidity struct StakeInfo { uint256 amount; // Amount staked uint256 rewardDebt; // For reward calculations uint256 stakeTime; // Stake creation time uint256 lockPeriod; // Lock duration in seconds uint256 multiplier; // Reward multiplier (100 = 1x) bool isActive; // Whether stake is active } ``` #### PoolInfo ```solidity struct PoolInfo { uint256 accRewardPerShare; // Accumulated rewards per share uint256 lastRewardTime; // Last reward calculation time uint256 totalStaked; // Total staked in pool } ``` ### Reward Multiplier System ```solidity uint256 public constant WEEK_MULTIPLIER = 100; // 1x base rate uint256 public constant MONTH_MULTIPLIER = 125; // 1.25x (+25%) uint256 public constant QUARTER_MULTIPLIER = 150; // 1.5x (+50%) uint256 public constant YEAR_MULTIPLIER = 200; // 2x (+100%) ``` ## Core Functions ### Staking Functions #### Stake Tokens ```solidity function stake(uint256 _amount, uint8 _lockPeriod) external ``` - Stake tokens with chosen lock period - Automatic multiplier calculation - Update pool rewards before staking #### Unstake Tokens ```solidity function unstake(uint256 _stakeId) external ``` - Withdraw after lock period expires - Receive staked tokens + accumulated rewards - Update pool state #### Claim Rewards ```solidity function claimRewards(uint256 _stakeId) external ``` - Claim rewards without unstaking - Keep tokens locked for multiplier - Compound earning potential ### View Functions #### Calculate Pending Rewards ```solidity function calculateReward(address _user, uint256 _stakeId) public view returns (uint256) ``` #### Get User Information ```solidity function getUserInfo(address _user) external view returns ( uint256 totalStaked, uint256 totalRewards, uint256 activeStakes, uint256 totalPendingRewards ) ``` ## Reward Calculation Algorithm ### Per-Second Rewards ```solidity // Base reward calculation uint256 timeElapsed = block.timestamp - poolInfo.lastRewardTime; uint256 reward = timeElapsed * rewardRate; // Reward per share poolInfo.accRewardPerShare += (reward * 1e12) / poolInfo.totalStaked; // User reward with multiplier uint256 baseReward = (stakeAmount * accRewardPerShare / 1e12) - rewardDebt; uint256 finalReward = (baseReward * multiplier) / 100; ``` ### Lock Period Benefits | Lock Period | Multiplier | APY Boost | Risk/Reward | |-------------|------------|-----------|-------------| | 1 Week | 1.0x | Base APY | Low risk, flexible | | 1 Month | 1.25x | +25% | Medium commitment | | 3 Months | 1.5x | +50% | Higher commitment | | 1 Year | 2.0x | +100% | Maximum rewards | ## Security Features ### Reentrancy Protection ```solidity modifier nonReentrant { require(_status != _ENTERED, "ReentrancyGuard: reentrant call"); _status = _ENTERED; _; _status = _NOT_ENTERED; } ``` ### Emergency Mechanisms ```solidity // Emergency pause function pause() external onlyOwner // Emergency withdrawal (no rewards) function emergencyWithdraw(uint256 _stakeId) external // Owner emergency fund recovery function emergencyWithdrawRewards(uint256 _amount) external onlyOwner ``` ### Input Validation ```solidity require(_amount > 0, "Cannot stake 0 tokens"); require(_lockPeriod >= 1 && _lockPeriod <= 4, "Invalid lock period"); require(block.timestamp >= stakeTime + lockPeriod, "Stake still locked"); ``` ## Usage Examples ### Basic Staking Flow ```javascript // 1. Approve staking contract await stakingToken.approve(stakingContract.address, amount); // 2. Stake for 1 month (lockPeriod = 2) await stakingContract.stake(amount, 2); // 3. Check pending rewards const rewards = await stakingContract.calculateReward(userAddress, stakeId); // 4. Claim rewards await stakingContract.claimRewards(stakeId); // 5. Unstake after lock period await stakingContract.unstake(stakeId); ``` ### Advanced Operations ```javascript // Get user's complete staking info const userInfo = await stakingContract.getUserInfo(userAddress); console.log(`Total Staked: ${userInfo.totalStaked}`); console.log(`Active Stakes: ${userInfo.activeStakes}`); console.log(`Pending Rewards: ${userInfo.totalPendingRewards}`); // Get specific stake details const stakeInfo = await stakingContract.getStakeInfo(userAddress, stakeId); console.log(`Can Unstake: ${stakeInfo.canUnstake}`); console.log(`Multiplier: ${stakeInfo.multiplier / 100}x`); ``` ## DeFi Concepts Demonstrated ### 1. Yield Farming - Earn rewards for providing liquidity - Time-based reward accrual - Compound interest through reward claiming ### 2. Liquidity Mining - Incentivize token holders to stake - Distribute governance/utility tokens as rewards - Bootstrap protocol adoption ### 3. Time Value of Money - Higher returns for longer commitments - Risk premium for illiquidity - Market maker incentives ### 4. Tokenomics - Reward token distribution - Inflation control mechanisms - Incentive alignment ## Real-World Applications ### Popular DeFi Protocols Using Similar Mechanics #### Compound Finance - Lend assets to earn interest - Automatic compound interest - Governance token (COMP) rewards #### Yearn Finance - Automated yield farming strategies - Vault system for optimized returns - YFI governance token #### SushiSwap - Liquidity provider rewards - SUSHI token incentives - Time-locked staking (xSUSHI) #### Curve Finance - Stable coin liquidity pools - CRV rewards with boost mechanisms - Vote-escrowed tokens (veCRV) ## Economic Analysis ### APY Calculation Example ``` Base APY: 10% Lock Period: 1 Year (2x multiplier) Effective APY: 20% Stake: 1000 tokens Annual Rewards: 200 tokens Monthly Rewards: ~16.67 tokens ``` ### Risk Assessment - Smart Contract Risk: Code bugs, exploits - Liquidity Risk: Funds locked for period - Market Risk: Token price volatility - Inflation Risk: Reward token devaluation ## Testing Strategy ### Unit Tests ```solidity // Test staking functionality function testStaking() public { uint256 amount = 1000e18; stakingContract.stake(amount, 1); // 1 week lock assertEq(stakingContract.userTotalStaked(user), amount); } // Test reward calculations function testRewardCalculation() public { // ... test reward math } // Test security features function testReentrancyProtection() public { // ... test attack scenarios } ``` ### Integration Tests - Multi-user scenarios - Edge case handling - Gas optimization verification - Frontend integration testing ## Deployment & Configuration ### Constructor Parameters ```solidity constructor( address _stakingToken, // Token to be staked address _rewardToken // Reward distribution token ) ``` ### Initial Setup ```javascript // 1. Deploy contract const staking = await SimpleStaking.deploy(stakingTokenAddress, rewardTokenAddress); // 2. Set reward rate await staking.setRewardRate(ethers.utils.parseEther("100")); // 100 tokens/second // 3. Fund reward pool await rewardToken.transfer(staking.address, ethers.utils.parseEther("1000000")); // 4. Verify setup console.log("Staking contract ready!"); ``` ## Learning Extensions ### 1. Advanced Features - Governance token voting power - NFT-based multipliers - Cross-chain staking - Automated compounding ### 2. Integration Patterns - DEX integration for swap-and-stake - Oracle price feeds for dynamic rewards - Insurance protocol integration - Multi-token rewards ### 3. Scaling Solutions - Layer 2 deployment (Polygon, Arbitrum) - State channel optimization - Batch transaction processing ## Job Skills Demonstrated - Advanced Solidity programming - DeFi protocol architecture - Mathematical modeling for rewards - Security-first development approach - Gas optimization techniques - Event-driven architecture - Access control patterns - Economic incentive design  This staking contract demonstrates production-ready DeFi development skills essential for senior blockchain developer roles!